// This schema is designed based on the "Second Brain" building blocks:
// 1. Drop Box (Capture)
// 2. Sorter (Classification)
// 3. Filing Cabinet (Storage)
// 4. Receipt (Audit)
// 5. Automation (AI Loops)

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- 0. AUTH & SaaS ---
model User {
  id            String    @id // Synced from auth.users
  name          String?   @default("New User")
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed password
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  trialEndsAt   DateTime? // For the 7-day free trial
  subscription  Subscription?
  settings      UserSettings?

  inboxItems    InboxItem[]
  entities      Entity[]
  workflows     Workflow[]
  calendarEvents CalendarEvent[]
}

model UserSettings {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id])
  
  geminiApiKey  String?  // Per-user API key override
  aiProvider    String   @default("GEMINI") // GEMINI, OLLAMA, MOCK
  
  infraApiKey   String?  @unique // For infrastructure/programmatic access
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  tier      String   @default("FREE") // FREE, BASIC, PRO, ENTERPRISE
  status    String   @default("ACTIVE")
  
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- 1. THE DROP BOX (Frictionless Capture) ---
model InboxItem {
  id        String   @id @default(cuid())
  content   String
  source    String
  createdAt DateTime @default(now())
  
  status    String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, NEEDS_USER_REVIEW
  confidence Float?  // "The Bouncer" confidence score
  
  processedEntityId String?
  processingError   String?

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
}

// --- 2. THE SORTER & FILING CABINET (Core Entities) ---
model Entity {
  id        String   @id @default(cuid())
  title     String
  content   String?  // Legacy content field, moving towards blocks
  type      String   // PROJECT, IDEA, PERSON, ADMIN, GOAL
  intent    String?  // e.g. Planning, Finance, Networking
  status    String?  @default("Active")
  confidence Float?  @default(1.0) // P-value
  
  tags      Tag[]
  linksFrom Link[] @relation("SourceLink")
  linksTo   Link[] @relation("TargetLink")
  
  summary   String?
  embedding String?  // Serialized vector embedding
  
  blocks    Block[]
  
  project   ProjectMetadata?
  person    PersonMetadata?
  idea      IdeaMetadata?
  admin     AdminMetadata?
  goal      GoalMetadata?
  
  reviews   Review[]

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Block {
  id        String   @id @default(cuid())
  type      String   // text, heading-1, heading-2, todo, image, etc.
  content   String?
  order     Int
  confidence Float?  @default(1.0) // P-value
  
  entityId  String
  entity    Entity   @relation(fields: [entityId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProjectMetadata {
  entityId    String   @id
  entity      Entity   @relation(fields: [entityId], references: [id])
  status      String   @default("Active")
  deadline    DateTime?
  priority    String?  @default("Medium")
  
  // Goal-reaching fields
  outcome     String?  // The desired clear outcome
  nextAction  String?  // The immediate next physical action (GTD)
  progress    Float?   @default(0) // 0 to 100
  
  // Advanced Fields
  blockers    String?
  budget      Float?
  riskLevel   String?  // Low, Medium, High
  health      String?  @default("On Track")
}

model PersonMetadata {
  entityId    String   @id
  entity      Entity   @relation(fields: [entityId], references: [id])
  email       String?
  phone       String?
  role        String?
  company     String?
  linkedin    String?
  lastContacted DateTime?
}

model IdeaMetadata {
  entityId    String   @id
  entity      Entity   @relation(fields: [entityId], references: [id])
  potential   String?  @default("Medium") // High, Medium, Low
  area        String?  // e.g. Tech, Art, Business
  
  // Advanced Fields
  impactScore Float?   // 1 to 10
  effortScore Float?   // 1 to 10
  feasibility String?  @default("Medium")
}

model AdminMetadata {
  entityId    String   @id
  entity      Entity   @relation(fields: [entityId], references: [id])
  category    String?  // Finance, Legal, Health, etc.
  importance  String?  @default("Medium")
  
  // Advanced Fields
  expiryDate  DateTime?
  effectiveDate DateTime?
  confidentiality String? @default("Internal")
}

model GoalMetadata {
  entityId    String   @id
  entity      Entity   @relation(fields: [entityId], references: [id])
  status      String   @default("Active")
  startDate   DateTime @default(now())
  targetDate  DateTime?
  priority    String?  @default("High")
  progress    Float?   @default(0)
  
  // New Achievement Fields
  successCriteria String? // Qualitative description of success
  motivation      String? // Why is this goal important? (The "Why")
  reward          String? // What happens when this is reached?
  obstacles       String? // Predicted challenges
  
  keyResults  KeyResult[]
}

model KeyResult {
  id           String   @id @default(cuid())
  name         String
  metricType   String   // Number, Percentage, Boolean, Currency
  initialValue Float    @default(0)
  targetValue  Float
  currentValue Float    @default(0)
  unit         String?  // lbs, %, $, etc.
  
  goalId       String
  goal         GoalMetadata @relation(fields: [goalId], references: [entityId])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Review {
  id          String   @id @default(cuid())
  type        String   // DAILY, WEEKLY, MONTHLY, QUARTERLY
  date        DateTime @default(now())
  
  entityId    String
  entity      Entity   @relation(fields: [entityId], references: [id])
  
  // Reflection fields
  wins        String?
  challenges  String?
  adjustments String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- 3. THE FORM (Structure) ---
model Tag {
  id       String   @id @default(cuid())
  name     String   @unique
  entities Entity[]
}

model Link {
  id        String   @id @default(cuid())
  sourceId  String
  source    Entity   @relation("SourceLink", fields: [sourceId], references: [id])
  targetId  String
  target    Entity   @relation("TargetLink", fields: [targetId], references: [id])
  type      String
  confidence Float?  @default(1.0) // P-value
}

// --- 4. AI LOOPS & AUTOMATION ---
model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  
  trigger     String
  conditions  String?    // Serialized JSON
  actions     String     // Serialized JSON
  
  logs        AuditLog[]

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  lastRunAt DateTime?
}

model CalendarEvent {
  id          String   @id @default(cuid())
  title       String
  description String?
  scheduledAt DateTime
  type        String   @default("NUDGE") // NUDGE, NOTIFICATION, TASK
  status      String   @default("PENDING") // PENDING, COMPLETED, CANCELLED
  
  // Actions to perform when triggered
  actions     String?  // Serialized JSON actions (like workflow actions)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- 5. THE RECEIPT (Audit Trail) ---
model AuditLog {
  id          String   @id @default(cuid())
  timestamp   DateTime @default(now())
  action      String
  details     String
  confidence  Float?
  
  workflowId  String?
  workflow    Workflow? @relation(fields: [workflowId], references: [id])
  
  entityId    String?
}
